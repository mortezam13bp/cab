<!DOCTYPE html>
<html lang="fa">
<head>
<meta charset="UTF-8">
<title>ویرایش تعاملی 3D کابینت</title>
<style>
  body { margin:0; overflow:hidden; font-family:sans-serif; direction:rtl; }
  #gui { position:absolute; top:10px; right:10px; background:#fff; padding:10px; border-radius:5px; z-index:1; width:300px; }
  label { display:block; margin:3px 0; }
  input, select { width:100%; }
  textarea { width:100%; height:120px; margin-top:5px; font-family: monospace; }
</style>
</head>
<body>

<div id="gui">
  <button onclick="addWall()">➕ دیوار</button>
  <hr>
  <label>دیوار انتخابی:</label>
  <select id="wallSelect"></select>
  <button onclick="addUnit()">➕ یونیت</button>
  <button onclick="addAppliance()">➕ وسیله</button>
  <hr>
  <label>Offset (m):</label>
  <input type="number" id="offsetInput" step="0.1" value="0">
  <label>Height (m):</label>
  <input type="number" id="heightInput" step="0.1" value="0">
  <button onclick="updatePosition()">بروزرسانی موقعیت</button>
  <hr>
  <textarea id="output" readonly></textarea>
</div>

<script src="https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.160.0/examples/js/controls/OrbitControls.js"></script>

<script>
let scene, camera, renderer, controls;
let walls=[], units=[], appliances=[], selectedElement=null;

initScene();
renderScene();
updateWallSelect();

function initScene(){
  scene = new THREE.Scene();
  scene.background = new THREE.Color(0xf0f0f0);
  camera = new THREE.PerspectiveCamera(60, window.innerWidth/window.innerHeight, 0.1, 1000);
  camera.position.set(0, 120, 200);
  renderer = new THREE.WebGLRenderer({antialias:true});
  renderer.setSize(window.innerWidth, window.innerHeight);
  document.body.appendChild(renderer.domElement);

  controls = new THREE.OrbitControls(camera, renderer.domElement);
  controls.enableDamping = true;

  const light = new THREE.DirectionalLight(0xffffff,1);
  light.position.set(100,200,100);
  scene.add(light);
  scene.add(new THREE.AmbientLight(0xffffff,0.5));
}

function renderScene(){
  requestAnimationFrame(renderScene);
  controls.update();
  renderer.render(scene, camera);
}

// ---------- مدیریت دیوارها ----------
function addWall(length=40, height=50, depth=2, angleDeg=0){
  let geometry = new THREE.BoxGeometry(length, height, depth);
  let material = new THREE.MeshStandardMaterial({color:0x0077ff});
  let wall = new THREE.Mesh(geometry, material);

  let x=0,z=0, rotY=0;
  if(walls.length>0){
    let prev = walls[walls.length-1];
    rotY = prev.rotationY;
    x = prev.position.x + Math.cos(prev.rotationY)*prev.length;
    z = prev.position.z + Math.sin(prev.rotationY)*prev.length;
  }

  wall.position.set(x + length/2, height/2, z);
  wall.rotation.y = rotY;
  wall.rotationY = rotY;
  wall.length = length;
  scene.add(wall);
  walls.push(wall);
  updateWallSelect();
  updatePrompt();
}

function updateWallSelect(){
  const sel = document.getElementById("wallSelect");
  sel.innerHTML="";
  walls.forEach((w,i)=>{ sel.innerHTML+=`<option value="${i}">دیوار ${i+1}</option>`; });
}

// ---------- مدیریت یونیت‌ها ----------
function addUnit(){
  if(walls.length===0) return;
  let width=20, height=30, depth=20;
  let geometry = new THREE.BoxGeometry(width, height, depth);
  let material = new THREE.MeshStandardMaterial({color:0xff0000});
  let unit = new THREE.Mesh(geometry, material);

  let wallIndex = parseInt(document.getElementById("wallSelect").value);
  let wall = walls[wallIndex];
  let offset = 0;
  let localX = -wall.length/2 + offset + width/2;
  let pos = new THREE.Vector3(localX, height/2, 0);
  pos.applyAxisAngle(new THREE.Vector3(0,1,0), wall.rotationY);
  pos.add(wall.position);

  unit.position.copy(pos);
  unit.rotation.y = wall.rotationY;
  scene.add(unit);
  units.push({mesh:unit, width,height,depth,wallIndex,offset});
  selectedElement = units[units.length-1];
  document.getElementById("offsetInput").value = offset;
  document.getElementById("heightInput").value = height;
  updatePrompt();
}

// ---------- مدیریت وسایل ----------
function addAppliance(){
  if(walls.length===0) return;
  let size=15;
  let geometry = new THREE.BoxGeometry(size,size*2,size);
  let material = new THREE.MeshStandardMaterial({color:0xffff00});
  let appliance = new THREE.Mesh(geometry, material);

  let wallIndex = parseInt(document.getElementById("wallSelect").value);
  let wall = walls[wallIndex];
  let offset = 0;
  let localX = -wall.length/2 + offset + size/2;
  let pos = new THREE.Vector3(localX, size, 0);
  pos.applyAxisAngle(new THREE.Vector3(0,1,0), wall.rotationY);
  pos.add(wall.position);

  appliance.position.copy(pos);
  appliance.rotation.y = wall.rotationY;
  scene.add(appliance);
  appliances.push({mesh:appliance, type:"Fridge", wallIndex, offset});
  selectedElement = appliances[appliances.length-1];
  document.getElementById("offsetInput").value = offset;
  document.getElementById("heightInput").value = size*2;
  updatePrompt();
}

// ---------- بروزرسانی موقعیت ----------
function updatePosition(){
  if(!selectedElement) return;
  let offset = parseFloat(document.getElementById("offsetInput").value);
  let height = parseFloat(document.getElementById("heightInput").value);
  let wall = walls[selectedElement.wallIndex];

  selectedElement.offset = offset;
  selectedElement.mesh.position.y = height/2;

  let localX = -wall.length/2 + offset + selectedElement.width/2 || selectedElement.mesh.geometry.parameters.width/2;
  let pos = new THREE.Vector3(localX, height/2, 0);
  pos.applyAxisAngle(new THREE.Vector3(0,1,0), wall.rotationY);
  pos.add(wall.position);
  selectedElement.mesh.position.copy(pos);

  updatePrompt();
}

// ---------- پرامپت خروجی ----------
function updatePrompt(){
  let text="Kitchen 3D preview:\n";
  walls.forEach((w,i)=>{ text+=`Wall ${i+1}: length=${w.length}, rotationY=${THREE.MathUtils.radToDeg(w.rotationY)}°\n`; });
  units.forEach((u,i)=>{ text+=`Unit ${i+1}: width=${u.width}, height=${u.height}, depth=${u.depth}, Wall=${u.wallIndex+1}, offset=${u.offset}m\n`; });
  appliances.forEach((a,i)=>{ text+=`Appliance ${i+1}: type=${a.type}, Wall=${a.wallIndex+1}, offset=${a.offset}m\n`; });
  document.getElementById("output").value=text;
}

// شروع با یک دیوار، یک یونیت و یک وسیله
addWall();
addUnit();
addAppliance();
renderScene();
</script>

</body>
</html>
